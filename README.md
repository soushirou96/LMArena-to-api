# ğŸš€ LMArena Bridge - AIæ¨¡å‹ç«æŠ€åœºAPIä»£ç†å™¨ ğŸŒ‰

> **ğŸ“– For English setup instructions, see [SETUP.md](SETUP.md)**  
> **ğŸ“– ä¸­æ–‡å®‰è£…è¯´æ˜è¯·ç»§ç»­é˜…è¯»æœ¬æ–‡æ¡£**

æ¬¢è¿æ¥åˆ°æ–°ä¸€ä»£çš„ LMArena Bridgeï¼ğŸ‰ è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI å’Œ WebSocket çš„é«˜æ€§èƒ½å·¥å…·é›†ï¼Œå®ƒèƒ½è®©ä½ é€šè¿‡ä»»ä½•å…¼å®¹ OpenAI API çš„å®¢æˆ·ç«¯æˆ–åº”ç”¨ç¨‹åºï¼Œæ— ç¼ä½¿ç”¨ [LMArena.ai](https://lmarena.ai/) å¹³å°ä¸Šæä¾›çš„æµ·é‡å¤§è¯­è¨€æ¨¡å‹ã€‚

è¿™ä¸ªé‡æ„ç‰ˆæœ¬æ—¨åœ¨æä¾›æ›´ç¨³å®šã€æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•çš„ä½“éªŒã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

*   **ğŸš€ é«˜æ€§èƒ½åç«¯**: åŸºäº **FastAPI** å’Œ **Uvicorn**ï¼Œæä¾›å¼‚æ­¥ã€é«˜æ€§èƒ½çš„ API æœåŠ¡ã€‚
*   **ğŸ”Œ ç¨³å®šçš„ WebSocket é€šä¿¡**: ä½¿ç”¨ WebSocket æ›¿ä»£ Server-Sent Events (SSE)ï¼Œå®ç°æ›´å¯é ã€ä½å»¶è¿Ÿçš„åŒå‘é€šä¿¡ã€‚
*   **ğŸ¤– OpenAI å…¼å®¹æ¥å£**: å®Œå…¨å…¼å®¹ OpenAI `v1/chat/completions`ã€`v1/models` ä»¥åŠ `v1/images/generations` ç«¯ç‚¹ã€‚
*   **ğŸ“‹ æ‰‹åŠ¨æ¨¡å‹åˆ—è¡¨æ›´æ–°**: æ–°å¢ `model_updater.py` è„šæœ¬ï¼Œå¯æ‰‹åŠ¨è§¦å‘ä» LMArena é¡µé¢æå–æœ€æ–°çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼Œå¹¶ä¿å­˜ä¸º `available_models.json`ï¼Œæ–¹ä¾¿æŸ¥é˜…å’Œæ›´æ–°æ ¸å¿ƒçš„ `models.json`ã€‚
*   **ğŸ“ é€šç”¨æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒé€šè¿‡ Base64 ä¸Šä¼ ä»»æ„ç±»å‹çš„æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€PDFã€ä»£ç ç­‰ï¼‰ï¼Œå¹¶æ”¯æŒä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚
*   **ğŸ¨ åŸç”Ÿæµå¼æ–‡ç”Ÿå›¾**: æ–‡ç”Ÿå›¾åŠŸèƒ½å·²ä¸æ–‡æœ¬ç”Ÿæˆå®Œå…¨ç»Ÿä¸€ã€‚åªéœ€åœ¨ `/v1/chat/completions` æ¥å£ä¸­è¯·æ±‚å›¾åƒæ¨¡å‹ï¼Œå³å¯åƒæ¥æ”¶æ–‡æœ¬ä¸€æ ·ï¼Œæµå¼æ¥æ”¶åˆ° Markdown æ ¼å¼çš„å›¾ç‰‡ã€‚
*   **ğŸ—£ï¸ å®Œæ•´å¯¹è¯å†å²æ”¯æŒ**: è‡ªåŠ¨å°†ä¼šè¯å†å²æ³¨å…¥åˆ° LMArenaï¼Œå®ç°æœ‰ä¸Šä¸‹æ–‡çš„è¿ç»­å¯¹è¯ã€‚
*   **ğŸŒŠ å®æ—¶æµå¼å“åº”**: åƒåŸç”Ÿ OpenAI API ä¸€æ ·ï¼Œå®æ—¶æ¥æ”¶æ¥è‡ªæ¨¡å‹çš„æ–‡æœ¬å›åº”ã€‚
*   **ğŸ”„ è‡ªåŠ¨ç¨‹åºæ›´æ–°**: å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ GitHub ä»“åº“ï¼Œå‘ç°æ–°ç‰ˆæœ¬æ—¶å¯è‡ªåŠ¨ä¸‹è½½å¹¶æ›´æ–°ç¨‹åºã€‚
*   **ğŸ†” ä¸€é”®å¼ä¼šè¯IDæ›´æ–°**: æä¾› `id_updater.py` è„šæœ¬ï¼Œåªéœ€åœ¨æµè§ˆå™¨æ“ä½œä¸€æ¬¡ï¼Œå³å¯è‡ªåŠ¨æ•è·å¹¶æ›´æ–° `config.jsonc` ä¸­æ‰€éœ€çš„ä¼šè¯ IDã€‚
*   **âš™ï¸ æµè§ˆå™¨è‡ªåŠ¨åŒ–**: é…å¥—çš„æ²¹çŒ´è„šæœ¬ (`LMArenaApiBridge.js`) è´Ÿè´£ä¸åç«¯æœåŠ¡å™¨é€šä¿¡ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œæ‰€æœ‰å¿…è¦æ“ä½œã€‚
*   **ğŸ» é…’é¦†æ¨¡å¼ (Tavern Mode)**: ä¸“ä¸º SillyTavern ç­‰åº”ç”¨è®¾è®¡ï¼Œæ™ºèƒ½åˆå¹¶ `system` æç¤ºè¯ï¼Œç¡®ä¿å…¼å®¹æ€§ã€‚
*   **ğŸ¤« Bypass æ¨¡å¼**: å°è¯•é€šè¿‡åœ¨è¯·æ±‚ä¸­é¢å¤–æ³¨å…¥ä¸€ä¸ªç©ºçš„ç”¨æˆ·æ¶ˆæ¯ï¼Œç»•è¿‡å¹³å°çš„æ•æ„Ÿè¯å®¡æŸ¥ã€‚
*   **ğŸ” API Key ä¿æŠ¤**: å¯åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® API Keyï¼Œä¸ºä½ çš„æœåŠ¡å¢åŠ ä¸€å±‚å®‰å…¨ä¿éšœã€‚
*   **ğŸ¯ æ¨¡å‹-ä¼šè¯é«˜çº§æ˜ å°„**: æ”¯æŒä¸ºä¸åŒæ¨¡å‹é…ç½®ç‹¬ç«‹çš„ä¼šè¯IDæ± ï¼Œå¹¶èƒ½ä¸ºæ¯ä¸ªä¼šè¯æŒ‡å®šç‰¹å®šçš„å·¥ä½œæ¨¡å¼ï¼ˆå¦‚ `battle` æˆ– `direct_chat`ï¼‰ï¼Œå®ç°æ›´ç²¾ç»†çš„è¯·æ±‚æ§åˆ¶ã€‚

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

é¡¹ç›®çš„ä¸»è¦è¡Œä¸ºé€šè¿‡ `config.jsonc`, `models.json` å’Œ `model_endpoint_map.json` è¿›è¡Œæ§åˆ¶ã€‚

### `models.json` - æ ¸å¿ƒæ¨¡å‹æ˜ å°„
è¿™ä¸ªæ–‡ä»¶åŒ…å«äº† LMArena å¹³å°ä¸Šçš„æ¨¡å‹åç§°åˆ°å…¶å†…éƒ¨IDçš„æ˜ å°„ï¼Œå¹¶æ”¯æŒé€šè¿‡ç‰¹å®šæ ¼å¼æŒ‡å®šæ¨¡å‹ç±»å‹ã€‚

*   **é‡è¦**: è¿™æ˜¯ç¨‹åºè¿è¡Œæ‰€**å¿…éœ€**çš„æ ¸å¿ƒæ–‡ä»¶ã€‚ä½ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªåˆ—è¡¨ã€‚
*   **æ ¼å¼**:
    *   **æ ‡å‡†æ–‡æœ¬æ¨¡å‹**: `"model-name": "model-id"`
    *   **å›¾åƒç”Ÿæˆæ¨¡å‹**: `"model-name": "model-id:image"`
*   **è¯´æ˜**:
    *   ç¨‹åºé€šè¿‡æ£€æŸ¥æ¨¡å‹IDå­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å« `:image` æ¥è¯†åˆ«å›¾åƒæ¨¡å‹ã€‚
    *   è¿™ç§æ ¼å¼ä¿æŒäº†å¯¹æ—§é…ç½®æ–‡ä»¶çš„æœ€å¤§å…¼å®¹æ€§ï¼ŒæœªæŒ‡å®šç±»å‹çš„æ¨¡å‹å°†é»˜è®¤ä¸º `"text"`ã€‚
*   **ç¤ºä¾‹**:
    ```json
    {
      "gemini-1.5-pro-flash-20240514": "gemini-1.5-pro-flash-20240514",
      "dall-e-3": "null:image"
    }
    ```

### `available_models.json` - å¯ç”¨æ¨¡å‹å‚è€ƒ (å¯é€‰)
*   è¿™æ˜¯ä¸€ä¸ª**å‚è€ƒæ–‡ä»¶**ï¼Œç”±æ–°å¢çš„ `model_updater.py` è„šæœ¬ç”Ÿæˆã€‚
*   å®ƒåŒ…å«äº†ä» LMArena é¡µé¢ä¸Šæå–çš„æ‰€æœ‰æ¨¡å‹çš„å®Œæ•´ä¿¡æ¯ï¼ˆID, åç§°, ç»„ç»‡ç­‰ï¼‰ã€‚
*   ä½ å¯ä»¥è¿è¡Œ `model_updater.py` æ¥ç”Ÿæˆæˆ–æ›´æ–°æ­¤æ–‡ä»¶ï¼Œç„¶åä»ä¸­å¤åˆ¶ä½ éœ€è¦ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯åˆ° `models.json` ä¸­ã€‚

### `config.jsonc` - å…¨å±€é…ç½®

è¿™æ˜¯ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†æœåŠ¡å™¨çš„å…¨å±€è®¾ç½®ã€‚

*   `session_id` / `message_id`: å…¨å±€é»˜è®¤çš„ä¼šè¯IDã€‚å½“æ¨¡å‹æ²¡æœ‰åœ¨ `model_endpoint_map.json` ä¸­æ‰¾åˆ°ç‰¹å®šæ˜ å°„æ—¶ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„IDã€‚
*   `id_updater_last_mode` / `id_updater_battle_target`: å…¨å±€é»˜è®¤çš„è¯·æ±‚æ¨¡å¼ã€‚åŒæ ·ï¼Œå½“ç‰¹å®šä¼šè¯æ²¡æœ‰æŒ‡å®šæ¨¡å¼æ—¶ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„è®¾ç½®ã€‚
*   `use_default_ids_if_mapping_not_found`: ä¸€ä¸ªéå¸¸é‡è¦çš„å¼€å…³ï¼ˆé»˜è®¤ä¸º `true`ï¼‰ã€‚
    *   `true`: å¦‚æœè¯·æ±‚çš„æ¨¡å‹åœ¨ `model_endpoint_map.json` ä¸­æ‰¾ä¸åˆ°ï¼Œå°±ä½¿ç”¨å…¨å±€é»˜è®¤çš„IDå’Œæ¨¡å¼ã€‚
    *   `false`: å¦‚æœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œåˆ™ç›´æ¥è¿”å›é”™è¯¯ã€‚è¿™åœ¨ä½ éœ€è¦ä¸¥æ ¼æ§åˆ¶æ¯ä¸ªæ¨¡å‹çš„ä¼šè¯æ—¶éå¸¸æœ‰ç”¨ã€‚
*   å…¶ä»–é…ç½®é¡¹å¦‚ `api_key`, `tavern_mode_enabled` ç­‰ï¼Œè¯·å‚è€ƒæ–‡ä»¶å†…çš„æ³¨é‡Šã€‚

### `model_endpoint_map.json` - æ¨¡å‹ä¸“å±é…ç½®

è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜çº§åŠŸèƒ½ï¼Œå…è®¸ä½ è¦†ç›–å…¨å±€é…ç½®ï¼Œä¸ºç‰¹å®šçš„æ¨¡å‹è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªä¸“å±çš„ä¼šè¯ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:
1.  **ä¼šè¯éš”ç¦»**: ä¸ºä¸åŒçš„æ¨¡å‹ä½¿ç”¨ç‹¬ç«‹çš„ä¼šè¯ï¼Œé¿å…ä¸Šä¸‹æ–‡ä¸²æ‰°ã€‚
2.  **æé«˜å¹¶å‘**: ä¸ºçƒ­é—¨æ¨¡å‹é…ç½®ä¸€ä¸ªIDæ± ï¼Œç¨‹åºä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªIDä½¿ç”¨ï¼Œæ¨¡æ‹Ÿè½®è¯¢ï¼Œå‡å°‘å•ä¸ªä¼šè¯è¢«é¢‘ç¹è¯·æ±‚çš„é£é™©ã€‚
3.  **æ¨¡å¼ç»‘å®š**: å°†ä¸€ä¸ªä¼šè¯IDä¸å®ƒè¢«æ•è·æ—¶çš„æ¨¡å¼ï¼ˆ`direct_chat` æˆ– `battle`ï¼‰ç»‘å®šï¼Œç¡®ä¿è¯·æ±‚æ ¼å¼æ°¸è¿œæ­£ç¡®ã€‚

**é…ç½®ç¤ºä¾‹**:
```json
{
  "claude-3-opus-20240229": [
    {
      "session_id": "session_for_direct_chat_1",
      "message_id": "message_for_direct_chat_1",
      "mode": "direct_chat"
    },
    {
      "session_id": "session_for_battle_A",
      "message_id": "message_for_battle_A",
      "mode": "battle",
      "battle_target": "A"
    }
  ],
  "gemini-1.5-pro-20241022": {
      "session_id": "single_session_id_no_mode",
      "message_id": "single_message_id_no_mode"
  }
}
```
*   **Opus**: é…ç½®äº†ä¸€ä¸ªIDæ± ã€‚è¯·æ±‚æ—¶ä¼šéšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§å…¶ç»‘å®šçš„ `mode` å’Œ `battle_target` æ¥å‘é€è¯·æ±‚ã€‚
*   **Gemini**: ä½¿ç”¨äº†å•ä¸ªIDå¯¹è±¡ï¼ˆæ—§æ ¼å¼ï¼Œä¾ç„¶å…¼å®¹ï¼‰ã€‚ç”±äºå®ƒæ²¡æœ‰æŒ‡å®š `mode`ï¼Œç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨ `config.jsonc` ä¸­å®šä¹‰çš„å…¨å±€æ¨¡å¼ã€‚

## ğŸ› ï¸ å®‰è£…ä¸ä½¿ç”¨

ä½ éœ€è¦å‡†å¤‡å¥½ Python ç¯å¢ƒå’Œä¸€æ¬¾æ”¯æŒæ²¹çŒ´è„šæœ¬çš„æµè§ˆå™¨ (å¦‚ Chrome, Firefox, Edge)ã€‚

### 1. å‡†å¤‡å·¥ä½œ

*   **å®‰è£… Python ä¾èµ–**
    æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    pip install -r requirements.txt
    ```

*   **å®‰è£…æ²¹çŒ´è„šæœ¬ç®¡ç†å™¨**
    ä¸ºä½ çš„æµè§ˆå™¨å®‰è£… [Tampermonkey](https://www.tampermonkey.net/) æ‰©å±•ã€‚

*   **å®‰è£…æœ¬é¡¹ç›®æ²¹çŒ´è„šæœ¬**
    1.  æ‰“å¼€ Tampermonkey æ‰©å±•çš„ç®¡ç†é¢æ¿ã€‚
    2.  ç‚¹å‡»â€œæ·»åŠ æ–°è„šæœ¬â€æˆ–â€œCreate a new scriptâ€ã€‚
    3.  å°† [`TampermonkeyScript/LMArenaApiBridge.js`](TampermonkeyScript/LMArenaApiBridge.js) æ–‡ä»¶ä¸­çš„æ‰€æœ‰ä»£ç å¤åˆ¶å¹¶ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­ã€‚
    4.  ä¿å­˜è„šæœ¬ã€‚

### 2. è¿è¡Œä¸»ç¨‹åº

1.  **å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨**
    åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œè¿è¡Œä¸»æœåŠ¡ç¨‹åºï¼š
    ```bash
    python api_server.py
    ```
    å½“ä½ çœ‹åˆ°æœåŠ¡å™¨åœ¨ `http://127.0.0.1:5102` å¯åŠ¨çš„æç¤ºæ—¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²å‡†å¤‡å°±ç»ªã€‚

2.  **ä¿æŒ LMArena é¡µé¢å¼€å¯**
    ç¡®ä¿ä½ è‡³å°‘æœ‰ä¸€ä¸ª LMArena é¡µé¢æ˜¯æ‰“å¼€çš„ï¼Œå¹¶ä¸”æ²¹çŒ´è„šæœ¬å·²æˆåŠŸè¿æ¥åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼ˆé¡µé¢æ ‡é¢˜ä¼šä»¥ `âœ…` å¼€å¤´ï¼‰ã€‚è¿™é‡Œæ— éœ€ä¿æŒåœ¨å¯¹è¯é¡µé¢ï¼Œåªè¦æ˜¯åŸŸåä¸‹çš„é¡µé¢éƒ½å¯ä»¥LeaderBoardéƒ½å¯ä»¥ã€‚

### 3. æ›´æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨ (å¯é€‰ï¼Œä½†æ¨è)
æ­¤æ­¥éª¤ä¼šç”Ÿæˆ `available_models.json` æ–‡ä»¶ï¼Œè®©ä½ çŸ¥é“å½“å‰ LMArena ä¸Šæœ‰å“ªäº›å¯ç”¨çš„æ¨¡å‹ï¼Œæ–¹ä¾¿ä½ æ›´æ–° `models.json`ã€‚
1.  **ç¡®ä¿ä¸»æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ**ã€‚
2.  æ‰“å¼€**ä¸€ä¸ªæ–°çš„ç»ˆç«¯**ï¼Œè¿è¡Œæ¨¡å‹æ›´æ–°å™¨ï¼š
    ```bash
    python model_updater.py
    ```
3.  è„šæœ¬ä¼šè‡ªåŠ¨è¯·æ±‚æµè§ˆå™¨æŠ“å–æ¨¡å‹åˆ—è¡¨ï¼Œå¹¶åœ¨æ ¹ç›®å½•ç”Ÿæˆ `available_models.json` æ–‡ä»¶ã€‚
4.  æ‰“å¼€ `available_models.json`ï¼Œæ‰¾åˆ°ä½ æƒ³è¦çš„æ¨¡å‹ï¼Œå°†å…¶ `"publicName"` å’Œ `"id"` é”®å€¼å¯¹å¤åˆ¶åˆ° `models.json` æ–‡ä»¶ä¸­ï¼ˆæ ¼å¼ä¸º `"publicName": "id"`ï¼‰ã€‚


#### ä½¿ç”¨ [use-model.py](use-model.py:1) å¿«é€Ÿç”Ÿæˆ [models.json](models.json:1)

- å‰ç½®æ¡ä»¶ï¼šç¡®ä¿å·²ç”Ÿæˆ [available_models.json](available_models.json:1)
  - æ–¹å¼ Aï¼šè¿è¡Œ [model_updater.py](model_updater.py:1)ï¼ˆéœ€è¦æµè§ˆå™¨é¡µé¢å·²è¿æ¥ï¼Œè¯¦è§ä¸Šæ–‡ï¼‰
  - æ–¹å¼ Bï¼šåœ¨ Docker+noVNC æ¨¡å¼ä¸‹æ‰§è¡Œ `--self-test`ï¼Œæµè§ˆå™¨å›ä¼ é¡µé¢åç”±åç«¯å†™å…¥ `available_models.json`
- ç”Ÿæˆ models.jsonï¼ˆè‡ªåŠ¨è¯†åˆ«å›¾åƒèƒ½åŠ›å¹¶åŠ ä¸Š `:image` åç¼€ï¼‰ï¼š
  ```bash
  python use-model.py
  ```
  - è¾“å‡ºç¤ºä¾‹ï¼š`âœ… å·²ç”Ÿæˆ models.jsonï¼Œå…± 123 ä¸ªæ¨¡å‹ã€‚`
- è§„åˆ™è¯´æ˜ï¼š
  - ä» `available_models.json` è¯»å–æ¯ä¸ªæ¡ç›®çš„ `publicName` ä¸ `id`ï¼Œå†™å…¥åˆ° [models.json](models.json:1)
  - è‹¥æ¡ç›® `capabilities.inputCapabilities.image == true`ï¼Œåˆ™å†™å…¥ä¸º `"id:image"` å½¢å¼ï¼Œä¾›åç«¯åŒºåˆ†æ–‡ç”Ÿå›¾æ¨¡å‹
- è¦†ç›–æé†’ï¼šè¯¥è„šæœ¬ä¼šæ•´ä½“è¦†ç›–ç°æœ‰ [models.json](models.json:1)ï¼Œå¦‚éœ€ä¿ç•™è‡ªå®šä¹‰æ¡ç›®ï¼Œè¯·å…ˆå¤‡ä»½æˆ–åœ¨ç”Ÿæˆåå†åˆå¹¶ä¿®æ”¹
- éªŒè¯ï¼š
  ```bash
  # åç«¯å·²å¯åŠ¨çš„å‰æä¸‹
  curl http://127.0.0.1:5102/v1/models
  ```
  - è‹¥è¿”å›åŒ…å«æ–°æ¨¡å‹åï¼Œè¡¨ç¤ºå·²ç”Ÿæ•ˆ
- ä¸‹ä¸€æ­¥ï¼ˆå¯é€‰ï¼‰ï¼šå¯åœ¨ [model_endpoint_map.json](model_endpoint_map.json:1) ä¸ºç‰¹å®šæ¨¡å‹é…ç½®ä¸“å±ä¼šè¯æ± ï¼Œä»¥å®ç°å¹¶å‘ä¸éš”ç¦»
### 4. é…ç½®ä¼šè¯ ID (éœ€è¦æ—¶ï¼Œä¸€èˆ¬åªé…ç½®ä¸€æ¬¡å³å¯ï¼Œé™¤éåˆ‡æ¢æ¨¡å‹æˆ–è€…åŸå¯¹è¯å¤±æ•ˆ)

è¿™æ˜¯**æœ€é‡è¦**çš„ä¸€æ­¥ã€‚ä½ éœ€è¦è·å–ä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯ ID å’Œæ¶ˆæ¯ IDï¼Œä»¥ä¾¿ç¨‹åºèƒ½å¤Ÿæ­£ç¡®åœ°ä¸ LMArena API é€šä¿¡ã€‚

1.  **ç¡®ä¿ä¸»æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ**
    `api_server.py` å¿…é¡»å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå› ä¸º ID æ›´æ–°å™¨éœ€è¦é€šè¿‡å®ƒæ¥æ¿€æ´»æµè§ˆå™¨çš„æ•è·åŠŸèƒ½ã€‚

2.  **è¿è¡Œ ID æ›´æ–°å™¨**
    æ‰“å¼€**ä¸€ä¸ªæ–°çš„ç»ˆç«¯**ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ `id_updater.py` è„šæœ¬ï¼š
    ```bash
    python id_updater.py
    ```
    *   è„šæœ¬ä¼šæç¤ºä½ é€‰æ‹©æ¨¡å¼ (DirectChat / Battle)ã€‚
    *   é€‰æ‹©åï¼Œå®ƒä¼šé€šçŸ¥æ­£åœ¨è¿è¡Œçš„ä¸»æœåŠ¡å™¨ã€‚

3.  **æ¿€æ´»ä¸æ•è·**
    *   æ­¤æ—¶ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°æµè§ˆå™¨ä¸­ LMArena é¡µé¢çš„æ ‡é¢˜æ æœ€å‰é¢å‡ºç°äº†ä¸€ä¸ªå‡†æ˜Ÿå›¾æ ‡ (ğŸ¯)ï¼Œè¿™è¡¨ç¤º**IDæ•è·æ¨¡å¼å·²æ¿€æ´»**ã€‚
    *   åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ª LMArena ç«æŠ€åœºçš„ **ç›®æ ‡æ¨¡å‹å‘é€ç»™æ¶ˆæ¯çš„é¡µé¢**ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ˜¯Battleé¡µé¢ï¼Œè¯·ä¸è¦æŸ¥çœ‹æ¨¡å‹åç§°ï¼Œä¿æŒåŒ¿åçŠ¶æ€ï¼Œå¹¶ä¿è¯å½“å‰æ¶ˆæ¯ç•Œé¢çš„æœ€åä¸€æ¡æ˜¯ç›®æ ‡æ¨¡å‹çš„ä¸€ä¸ªå›ç­”ï¼›å¦‚æœæ˜¯Direct Chatï¼Œè¯·ä¿è¯å½“å‰æ¶ˆæ¯ç•Œé¢çš„æœ€åä¸€æ¡æ˜¯ç›®æ ‡æ¨¡å‹çš„ä¸€ä¸ªå›ç­”ã€‚
    *   **ç‚¹å‡»ç›®æ ‡æ¨¡å‹çš„å›ç­”å¡ç‰‡å³ä¸Šè§’çš„é‡è¯•ï¼ˆRetryï¼‰æŒ‰é’®**ã€‚
    *   æ²¹çŒ´è„šæœ¬ä¼šæ•è·åˆ° `sessionId` å’Œ `messageId`ï¼Œå¹¶å°†å…¶å‘é€ç»™ `id_updater.py`ã€‚

4.  **éªŒè¯ç»“æœ**
    *   å›åˆ°ä½ è¿è¡Œ `id_updater.py` çš„ç»ˆç«¯ï¼Œä½ ä¼šçœ‹åˆ°å®ƒæ‰“å°å‡ºæˆåŠŸæ•è·åˆ°çš„ IDï¼Œå¹¶æç¤ºå·²å°†å…¶å†™å…¥ `config.jsonc` æ–‡ä»¶ã€‚
    *   è„šæœ¬åœ¨æˆåŠŸåä¼šè‡ªåŠ¨å…³é—­ã€‚ç°åœ¨ä½ çš„é…ç½®å·²å®Œæˆï¼

### 5. é…ç½®ä½ çš„ OpenAI å®¢æˆ·ç«¯
å°†ä½ çš„å®¢æˆ·ç«¯æˆ–åº”ç”¨çš„ OpenAI API åœ°å€æŒ‡å‘æœ¬åœ°æœåŠ¡å™¨ï¼š
*   **API Base URL**: `http://127.0.0.1:5102/v1`
*   **API Key**: å¦‚æœ `config.jsonc` ä¸­çš„ `api_key` ä¸ºç©ºï¼Œåˆ™å¯éšä¾¿è¾“å…¥ï¼›å¦‚æœå·²è®¾ç½®ï¼Œåˆ™å¿…é¡»æä¾›æ­£ç¡®çš„ Keyã€‚
*   **Model Name**: åœ¨ä½ çš„å®¢æˆ·ç«¯ä¸­æŒ‡å®šä½ æƒ³ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼ˆ**å¿…é¡»ä¸ `models.json` ä¸­çš„åç§°å®Œå…¨åŒ¹é…**ï¼‰ã€‚æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªåç§°æŸ¥æ‰¾å¯¹åº”çš„æ¨¡å‹IDã€‚

### 6. å¼€å§‹èŠå¤©ï¼ ğŸ’¬
ç°åœ¨ä½ å¯ä»¥æ­£å¸¸ä½¿ç”¨ä½ çš„å®¢æˆ·ç«¯äº†ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡æœ¬åœ°æœåŠ¡å™¨ä»£ç†åˆ° LMArena ä¸Šï¼

## ğŸ¤” å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

è¿™ä¸ªé¡¹ç›®ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªæœ¬åœ° Python **FastAPI** æœåŠ¡å™¨å’Œä¸€ä¸ªåœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„**æ²¹çŒ´è„šæœ¬**ã€‚å®ƒä»¬é€šè¿‡ **WebSocket** ååŒå·¥ä½œã€‚

```mermaid
sequenceDiagram
    participant C as OpenAI å®¢æˆ·ç«¯ ğŸ’»
    participant S as æœ¬åœ° FastAPI æœåŠ¡å™¨ ğŸ
    participant MU as æ¨¡å‹æ›´æ–°è„šæœ¬ (model_updater.py) ğŸ“‹
    participant IU as ID æ›´æ–°è„šæœ¬ (id_updater.py) ğŸ†”
    participant T as æ²¹çŒ´è„šæœ¬ ğŸµ (åœ¨ LMArena é¡µé¢)
    participant L as LMArena.ai ğŸŒ

    alt åˆå§‹åŒ–
        T->>+S: (é¡µé¢åŠ è½½) å»ºç«‹ WebSocket è¿æ¥
        S-->>-T: ç¡®è®¤è¿æ¥
    end

    alt æ‰‹åŠ¨æ›´æ–°æ¨¡å‹åˆ—è¡¨ (å¯é€‰)
        MU->>+S: (ç”¨æˆ·è¿è¡Œ) POST /internal/request_model_update
        S->>T: (WebSocket) å‘é€ 'send_page_source' æŒ‡ä»¤
        T->>T: æŠ“å–é¡µé¢ HTML
        T->>S: (HTTP) POST /internal/update_available_models (å«HTML)
        S->>S: è§£æHTMLå¹¶ä¿å­˜åˆ° available_models.json
        S-->>-MU: ç¡®è®¤
    end

    alt æ‰‹åŠ¨æ›´æ–°ä¼šè¯ID
        IU->>+S: (ç”¨æˆ·è¿è¡Œ) POST /internal/start_id_capture
        S->>T: (WebSocket) å‘é€ 'activate_id_capture' æŒ‡ä»¤
        T->>L: (ç”¨æˆ·ç‚¹å‡»Retry) æ‹¦æˆªåˆ° fetch è¯·æ±‚
        T->>IU: (HTTP) å‘é€æ•è·åˆ°çš„ID
        IU->>IU: æ›´æ–° config.jsonc
        IU-->>-T: ç¡®è®¤
    end

    alt æ­£å¸¸èŠå¤©æµç¨‹
        C->>+S: (ç”¨æˆ·èŠå¤©) /v1/chat/completions è¯·æ±‚
        S->>S: è½¬æ¢è¯·æ±‚ä¸º LMArena æ ¼å¼ (å¹¶ä» models.json è·å–æ¨¡å‹ID)
        S->>T: (WebSocket) å‘é€åŒ…å« request_id å’Œè½½è·çš„æ¶ˆæ¯
        T->>L: (fetch) å‘é€çœŸå®è¯·æ±‚åˆ° LMArena API
        L-->>T: (æµå¼)è¿”å›æ¨¡å‹å“åº”
        T->>S: (WebSocket) å°†å“åº”æ•°æ®å—ä¸€å—å—å‘å›
        S-->>-C: (æµå¼) è¿”å› OpenAI æ ¼å¼çš„å“åº”
    end

    alt æ­£å¸¸èŠå¤©æµç¨‹ (åŒ…å«æ–‡ç”Ÿå›¾)
        C->>+S: (ç”¨æˆ·èŠå¤©) /v1/chat/completions è¯·æ±‚
        S->>S: æ£€æŸ¥æ¨¡å‹åç§°
        alt å¦‚æœæ˜¯æ–‡ç”Ÿå›¾æ¨¡å‹ (å¦‚ DALL-E)
            S->>S: (å¹¶è¡Œ) åˆ›å»º n ä¸ªæ–‡ç”Ÿå›¾ä»»åŠ¡
            S->>T: (WebSocket) å‘é€ n ä¸ªåŒ…å« request_id çš„ä»»åŠ¡
            T->>L: (fetch) å‘é€ n ä¸ªçœŸå®è¯·æ±‚
            L-->>T: (æµå¼) è¿”å›å›¾ç‰‡ URL
            T->>S: (WebSocket) å°† URL å‘å›
            S->>S: å°† URL æ ¼å¼åŒ–ä¸º Markdown æ–‡æœ¬
            S-->>-C: (HTTP) è¿”å›åŒ…å« Markdown å›¾ç‰‡çš„èŠå¤©å“åº”
        else å¦‚æœæ˜¯æ™®é€šæ–‡æœ¬æ¨¡å‹
            S->>S: è½¬æ¢è¯·æ±‚ä¸º LMArena æ ¼å¼
            S->>T: (WebSocket) å‘é€åŒ…å« request_id å’Œè½½è·çš„æ¶ˆæ¯
            T->>L: (fetch) å‘é€çœŸå®è¯·æ±‚åˆ° LMArena API
            L-->>T: (æµå¼)è¿”å›æ¨¡å‹å“åº”
            T->>S: (WebSocket) å°†å“åº”æ•°æ®å—ä¸€å—å—å‘å›
            S-->>-C: (æµå¼) è¿”å› OpenAI æ ¼å¼çš„å“åº”
        end
    end
```

1.  **å»ºç«‹è¿æ¥**: å½“ä½ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ LMArena é¡µé¢æ—¶ï¼Œ**æ²¹çŒ´è„šæœ¬**ä¼šç«‹å³ä¸**æœ¬åœ° FastAPI æœåŠ¡å™¨**å»ºç«‹ä¸€ä¸ªæŒä¹…çš„ **WebSocket è¿æ¥**ã€‚
    > **æ³¨æ„**: å½“å‰æ¶æ„å‡å®šåªæœ‰ä¸€ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µåœ¨å·¥ä½œã€‚å¦‚æœæ‰“å¼€å¤šä¸ªé¡µé¢ï¼Œåªæœ‰æœ€åä¸€ä¸ªè¿æ¥ä¼šç”Ÿæ•ˆã€‚
2.  **æ¥æ”¶è¯·æ±‚**: **OpenAI å®¢æˆ·ç«¯**å‘æœ¬åœ°æœåŠ¡å™¨å‘é€æ ‡å‡†çš„èŠå¤©è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®š `model` åç§°ã€‚
3.  **ä»»åŠ¡åˆ†å‘**: æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ® `model` åç§°ä» `models.json` æŸ¥æ‰¾å¯¹åº”çš„æ¨¡å‹IDï¼Œç„¶åå°†è¯·æ±‚è½¬æ¢ä¸º LMArena éœ€è¦çš„æ ¼å¼ï¼Œå¹¶é™„ä¸Šä¸€ä¸ªå”¯ä¸€çš„è¯·æ±‚ ID (`request_id`)ï¼Œæœ€åé€šè¿‡ WebSocket å°†è¿™ä¸ªä»»åŠ¡å‘é€ç»™å·²è¿æ¥çš„æ²¹çŒ´è„šæœ¬ã€‚
4.  **æ‰§è¡Œä¸å“åº”**: æ²¹çŒ´è„šæœ¬æ”¶åˆ°ä»»åŠ¡åï¼Œä¼šç›´æ¥å‘ LMArena çš„ API ç«¯ç‚¹å‘èµ· `fetch` è¯·æ±‚ã€‚å½“ LMArena è¿”å›æµå¼å“åº”æ—¶ï¼Œæ²¹çŒ´è„šæœ¬ä¼šæ•è·è¿™äº›æ•°æ®å—ï¼Œå¹¶å°†å®ƒä»¬ä¸€å—å—åœ°é€šè¿‡ WebSocket å‘å›ç»™æœ¬åœ°æœåŠ¡å™¨ã€‚
5.  **å“åº”ä¸­ç»§**: æœåŠ¡å™¨æ ¹æ®æ¯å—æ•°æ®é™„å¸¦çš„ `request_id`ï¼Œå°†å…¶æ”¾å…¥æ­£ç¡®çš„å“åº”é˜Ÿåˆ—ä¸­ï¼Œå¹¶å®æ—¶åœ°å°†è¿™äº›æ•°æ®æµå¼ä¼ è¾“å› OpenAI å®¢æˆ·ç«¯ã€‚

## ğŸ“– API ç«¯ç‚¹

### è·å–æ¨¡å‹åˆ—è¡¨

*   **ç«¯ç‚¹**: `GET /v1/models`
*   **æè¿°**: è¿”å›ä¸€ä¸ªä¸ OpenAI å…¼å®¹çš„æ¨¡å‹åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ä» `models.json` æ–‡ä»¶ä¸­è¯»å–ã€‚

### èŠå¤©è¡¥å…¨

*   **ç«¯ç‚¹**: `POST /v1/chat/completions`
*   **æè¿°**: æ¥æ”¶æ ‡å‡†çš„ OpenAI èŠå¤©è¯·æ±‚ï¼Œæ”¯æŒæµå¼å’Œéæµå¼å“åº”ã€‚

### å›¾åƒç”Ÿæˆ (å·²é›†æˆ)

*   **ç«¯ç‚¹**: `POST /v1/chat/completions`
*   **æè¿°**: æ–‡ç”Ÿå›¾åŠŸèƒ½ç°å·²å®Œå…¨é›†æˆåˆ°ä¸»èŠå¤©ç«¯ç‚¹ä¸­ã€‚è¦ç”Ÿæˆå›¾ç‰‡ï¼Œåªéœ€åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®šä¸€ä¸ªå›¾åƒæ¨¡å‹ï¼ˆä¾‹å¦‚ `"model": "dall-e-3"`ï¼‰ï¼Œç„¶ååƒå‘é€æ™®é€šèŠå¤©æ¶ˆæ¯ä¸€æ ·å‘é€è¯·æ±‚å³å¯ã€‚æœåŠ¡å™¨ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶å¤„ç†ã€‚
*   **è¯·æ±‚ç¤ºä¾‹**:
    ```bash
    curl http://127.0.0.1:5102/v1/chat/completions \
      -H "Content-Type: application/json" \
      -d '{
        "model": "dall-e-3",
        "messages": [
          {
            "role": "user",
            "content": "A futuristic cityscape at sunset, neon lights, flying cars"
          }
        ],
        "n": 1
      }'
    ```
*   **å“åº”ç¤ºä¾‹ (ä¸æ™®é€šèŠå¤©ä¸€è‡´)**:
    ```json
    {
      "id": "img-as-chat-...",
      "object": "chat.completion",
      "created": 1677663338,
      "model": "dall-e-3",
      "choices": [
        {
          "index": 0,
          "message": {
            "role": "assistant",
            "content": "![A futuristic cityscape at sunset, neon lights, flying cars](https://...)"
          },
          "finish_reason": "stop"
        }
      ],
      "usage": { ... }
    }
    ```

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ .gitignore                  # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ api_server.py               # æ ¸å¿ƒåç«¯æœåŠ¡ (FastAPI) ğŸ
â”œâ”€â”€ id_updater.py               # ä¸€é”®å¼ä¼šè¯IDæ›´æ–°è„šæœ¬ ğŸ†”
â”œâ”€â”€ model_updater.py              # æ‰‹åŠ¨æ¨¡å‹åˆ—è¡¨æ›´æ–°è„šæœ¬ ğŸ“‹
â”œâ”€â”€ models.json                 # æ ¸å¿ƒæ¨¡å‹æ˜ å°„è¡¨ (éœ€æ‰‹åŠ¨ç»´æŠ¤) ğŸ—ºï¸
â”œâ”€â”€ available_models.json       # å¯ç”¨æ¨¡å‹å‚è€ƒåˆ—è¡¨ (è‡ªåŠ¨ç”Ÿæˆ) ğŸ“„
â”œâ”€â”€ model_endpoint_map.json     # [é«˜çº§] æ¨¡å‹åˆ°ä¸“å±ä¼šè¯IDçš„æ˜ å°„è¡¨ ğŸ¯
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–åŒ…åˆ—è¡¨ ğŸ“¦
â”œâ”€â”€ README.md                   # å°±æ˜¯ä½ ç°åœ¨æ­£åœ¨çœ‹çš„è¿™ä¸ªæ–‡ä»¶ ğŸ‘‹
â”œâ”€â”€ config.jsonc                # å…¨å±€åŠŸèƒ½é…ç½®æ–‡ä»¶ âš™ï¸
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ update_script.py        # è‡ªåŠ¨æ›´æ–°é€»è¾‘è„šæœ¬ ğŸ”„
â””â”€â”€ TampermonkeyScript/
    â””â”€â”€ LMArenaApiBridge.js     # å‰ç«¯è‡ªåŠ¨åŒ–æ²¹çŒ´è„šæœ¬ ğŸµ
```

**äº«å—åœ¨ LMArena çš„æ¨¡å‹ä¸–ç•Œä¸­è‡ªç”±æ¢ç´¢çš„ä¹è¶£å§ï¼** ğŸ’–

## ğŸ§­ Docker+noVNC æµè§ˆå™¨è‡ªåŠ¨åŒ–æ¨¡å¼ï¼ˆå‘½ä»¤è¡Œæ— å¤´ä¼˜å…ˆï¼Œé‡ Cloudflare åˆ‡æ¢åˆ°ç½‘é¡µç«¯å¯è§†æ“ä½œï¼‰

æœ¬æ¨¡å¼é€šè¿‡ Docker å¯åŠ¨ä¸€ä¸ªå¸¦ WebDriver ä¸ noVNC çš„ Chrome å®ä¾‹ï¼Œé»˜è®¤ä»¥â€œè‡ªåŠ¨åŒ–+æ— å¤´ä¼˜å…ˆâ€çš„æ–¹å¼è¿è¡Œï¼›å½“æ£€æµ‹åˆ° LMArena çš„ Cloudflare è´¨è¯¢/è®¤è¯æ—¶ï¼Œä¼šæç¤ºä½ æ‰“å¼€ noVNC ç½‘é¡µè¿›è¡Œäººå·¥æ“ä½œï¼Œå®Œæˆåè‡ªåŠ¨å›åˆ°æ— å¤´è‡ªåŠ¨åŒ–æµç¨‹ã€‚

- ç›¸å…³æ–‡ä»¶ï¼š
  - å¯åŠ¨å™¨è„šæœ¬ï¼š[`scripts/docker_browser_runner.py`](scripts/docker_browser_runner.py:1)
  - ä¸€é”®å¯åŠ¨ï¼ˆWindowsï¼‰ï¼š[`run_docker_browser.bat`](run_docker_browser.bat:1)
  - æ³¨å…¥çš„ç”¨æˆ·è„šæœ¬æ¥æºï¼š[`TampermonkeyScript/LMArenaApiBridge.js`](TampermonkeyScript/LMArenaApiBridge.js:1)
  - åç«¯æœåŠ¡ï¼š[`api_server.py`](api_server.py:1)
  - Python ä¾èµ–ï¼š[`requirements.txt`](requirements.txt:1)

### å…ˆå†³æ¡ä»¶

- å·²å®‰è£…å¹¶è¿è¡Œ Docker Desktopï¼ˆWindows 11ï¼‰
- æœ¬åœ°å·²è¿è¡Œ LMArena Bridge åç«¯ï¼ˆé»˜è®¤ç«¯å£ 5102/5103ï¼‰
  - å¯åŠ¨åç«¯ï¼š  
    ```bash
    python api_server.py
    ```
- é¦–æ¬¡å®‰è£…ä¾èµ–ï¼š  
  ```bash
  pip install -r requirements.txt
  ```

### å¯åŠ¨æ–¹å¼ Aï¼ˆæ¨èï¼ŒWindows ä¸€é”®è„šæœ¬ï¼‰

```bash
.\run_docker_browser.bat --url https://lmarena.ai/
```

- é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨æ‹‰å–é•œåƒ `selenium/standalone-chrome:latest`ï¼Œå¹¶æ˜ å°„ 4444(WebDriver)/7900(noVNC)
- è„šæœ¬ä¼šè¿æ¥ WebDriverï¼Œå‘æ‰€æœ‰æ–°æ–‡æ¡£æ³¨å…¥ç”¨æˆ·è„šæœ¬ï¼ˆç­‰ä»· Tampermonkeyï¼‰ï¼Œéšåè®¿é—® `--url` æŒ‡å®šé¡µé¢

å½“å‘½ä»¤è¡Œæç¤ºæ£€æµ‹åˆ° Cloudflare è´¨è¯¢æ—¶ï¼Œä¼šæ‰“å° noVNC è®¿é—®åœ°å€ï¼š
- æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:7900/?autoconnect=1&resize=scale&password=secret`
- åœ¨ noVNC é¡µé¢ä¸­æ‰‹åŠ¨å®ŒæˆäººæœºéªŒè¯
- å›åˆ°å‘½ä»¤è¡Œï¼ŒæŒ‰å›è½¦ç»§ç»­ï¼Œå³å¯æ¢å¤æ— å¤´è‡ªåŠ¨åŒ–æµç¨‹

### å¯åŠ¨æ–¹å¼ Bï¼ˆPython ç›´æ¥è¿è¡Œï¼‰

```bash
python scripts\docker_browser_runner.py --url https://lmarena.ai/
```

å¯é€‰å‚æ•°ï¼š
- `--image` è‡ªå®šä¹‰é•œåƒï¼ˆé»˜è®¤ `selenium/standalone-chrome:latest`ï¼‰
- `--name` å®¹å™¨åç§°ï¼ˆé»˜è®¤ `lm_cf_browser`ï¼‰
- `--keep-container` é€€å‡ºæ—¶ä¿ç•™å®¹å™¨ï¼ˆé»˜è®¤é€€å‡ºå³åœæ­¢å¹¶æ¸…ç†å®¹å™¨ï¼‰
- `--self-test` å¯åŠ¨åæ‰§è¡Œè¿é€šæ€§è‡ªæ£€ï¼›ä¼šé€šè¿‡æœ¬æœº `POST /internal/request_model_update` æŒ‡ä»¤ï¼Œç­‰å¾…æµè§ˆå™¨å›ä¼ é¡µé¢åç”±åç«¯æ›´æ–° `available_models.json`ï¼Œç”¨äºéªŒè¯â€œå®¹å™¨æµè§ˆå™¨ â‡„ æ²¹çŒ´è„šæœ¬ â‡„ æœ¬æœºåç«¯â€çš„é€šè·¯æ˜¯å¦ç•…é€š
- `--test-timeout` è‡ªæ£€çš„æœ€å¤§ç­‰å¾…ç§’æ•°ï¼ˆé»˜è®¤ 45ï¼‰

### è¿é€šæ€§è‡ªæ£€ï¼ˆå¯é€‰ï¼‰

- å‰ç½®æ¡ä»¶ï¼šæœ¬æœºåç«¯å·²è¿è¡Œå¹¶ç›‘å¬ `http://127.0.0.1:5102`ï¼Œä¸”é¡µé¢æ ‡é¢˜å‡ºç°â€œâœ…â€ï¼ˆè¡¨ç¤ºè„šæœ¬å·²è¿ä¸Š WebSocketï¼‰ã€‚
- æ‰§è¡Œå‘½ä»¤ï¼š
  ```bash
  .\run_docker_browser.bat --url https://lmarena.ai/ --self-test
  ```
- åˆ¤å®šæ ‡å‡†ï¼šæ§åˆ¶å°å‡ºç°â€œavailable_models.json å·²æ›´æ–°ï¼Œè¿é€šæ€§è‡ªæ£€é€šè¿‡â€ã€‚è‹¥è¶…æ—¶ï¼š
  - æ£€æŸ¥ç½‘ç»œ/å®‰å…¨è½¯ä»¶æ˜¯å¦æ‹¦æˆª `host.docker.internal:5102/5103`
  - æ‰“å¼€ noVNC ååœ¨å®¹å™¨å†…åˆ·æ–° LMArena é¡µé¢ï¼ˆF5ï¼‰
  - ç¡®ä¿é¡µé¢æ ‡é¢˜å‡ºç°â€œâœ…â€æ ‡è®°

### å·¥ä½œæœºåˆ¶è¯´æ˜

- ç”¨æˆ·è„šæœ¬æ³¨å…¥
  - å¯åŠ¨å™¨é€šè¿‡ Chrome CDP çš„ `Page.addScriptToEvaluateOnNewDocument` å°†ç”¨æˆ·è„šæœ¬åœ¨æ¯ä¸ªæ–°æ–‡æ¡£çš„ document_start æ³¨å…¥ï¼Œæ— éœ€å®‰è£…æµè§ˆå™¨æ‰©å±•
  - ä¸ºå…¼å®¹å®¹å™¨ç½‘ç»œï¼Œè„šæœ¬ä¸­çš„æœ¬æœºåœ°å€ä¼šè‡ªåŠ¨æ”¹å†™ä¸º `host.docker.internal`ï¼š
    - `ws://localhost:5102` â†’ `ws://host.docker.internal:5102`
    - `http://127.0.0.1:5103` â†’ `http://host.docker.internal:5103`
  - ä»…åœ¨ `*.lmarena.ai` åŸŸè‡ªåŠ¨ç”Ÿæ•ˆï¼Œé¿å…å½±å“å…¶ä»–ç½‘ç«™

- Cloudflare æ£€æµ‹ä¸åˆ‡æ¢
  - é¡µé¢å« `challenges.cloudflare.com`/`cf-chl`/`turnstile` ç­‰ç‰¹å¾å³åˆ¤å®šéœ€è¦äººå·¥ä»‹å…¥
  - å¯åŠ¨å™¨æç¤ºä½ æ‰“å¼€ noVNCï¼Œå®ŒæˆéªŒè¯åå›è½¦ç»§ç»­

- ä¼šè¯ä¿æŒ
  - éªŒè¯é€šè¿‡åï¼Œç»§ç»­ä»¥æ— å¤´è‡ªåŠ¨åŒ–æ–¹å¼è®¿é—®ç›®æ ‡é¡µé¢ï¼›å®¹å™¨å†…æµè§ˆå™¨ä¸ä¸»æœºçš„åç«¯é€šè¿‡ `host.docker.internal` è¿›è¡Œé€šä¿¡

### å¸¸ç”¨æ“ä½œ

- æŒ‡å®šä¸åŒçš„èµ·å§‹é¡µé¢ï¼š
  ```bash
  .\run_docker_browser.bat --url https://lmarena.ai/arena
  ```
- ä¿ç•™å®¹å™¨ç”¨äºé•¿æœŸè§‚å¯Ÿï¼ˆéœ€æ‰‹åŠ¨åœæ­¢ï¼‰ï¼š
  ```bash
  python scripts\docker_browser_runner.py --keep-container
  docker rm -f lm_cf_browser
  ```

### æ•…éšœæ’æŸ¥

- è®¿é—® noVNC ç©ºç™½/è¿æ¥å¤±è´¥
  - ç¡®è®¤ Docker å®¹å™¨æ­£åœ¨è¿è¡Œï¼ˆåç§°é»˜è®¤ä¸º `lm_cf_browser`ï¼‰
  - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆ7900/noVNCã€4444/WebDriverï¼‰
- å®¹å™¨å†…è„šæœ¬è¿æ¥ä¸åˆ°æœ¬åœ°åç«¯
  - ç¡®è®¤ `api_server.py` åœ¨æœ¬æœºè¿è¡Œä¸”ç›‘å¬ `127.0.0.1:5102`
  - Windows ä¸‹ `host.docker.internal` åº”å¯è§£æåˆ°å®¿ä¸»æœºï¼›è‹¥ç½‘ç»œç­–ç•¥é™åˆ¶ï¼Œè¯·æ”¾å¼€ 5102/5103 æœ¬æœºå…¥ç«™è®¿é—®
- ä¸€ç›´æç¤º Cloudflare éªŒè¯
  - åœ¨ noVNC ä¸­åˆ·æ–°å¹¶é‡è¯•ï¼›ç¡®ä¿å›¾å½¢åŒ–éªŒè¯å·²çœŸæ­£å®Œæˆåï¼Œå†å›åˆ°å‘½ä»¤è¡Œå›è½¦ç»§ç»­

### å¯åŠ¨æ–¹å¼ Cï¼ˆdocker-composeï¼‰

- é€‚ç”¨åœºæ™¯ï¼šå¸Œæœ›ç”¨ Compose å¸¸é©»å¯åŠ¨å¸¦ WebDriver ä¸ noVNC çš„å®¹å™¨æµè§ˆå™¨ï¼Œç”±å®¿ä¸»å†è¿è¡Œå¼•å¯¼å™¨å®Œæˆâ€œè¿æ¥ + Userscript æ³¨å…¥ + Cloudflare å¤„ç†â€ã€‚
- ç›¸å…³æ–‡ä»¶ï¼š
  - Compose æ¸…å•ï¼š[`docker-compose.yml`](docker-compose.yml:1)
  - å¼•å¯¼å™¨ï¼š[`scripts/docker_browser_runner.py`](scripts/docker_browser_runner.py:1)
  - åç«¯æœåŠ¡ï¼š[`api_server.py`](api_server.py:1)

æ­¥éª¤
1) å¯åŠ¨åç«¯ï¼ˆå»ºè®®å…ˆå¼€ç€ï¼‰
   ```bash
   python api_server.py
   ```
2) ä½¿ç”¨ Compose å¯åŠ¨å®¹å™¨æµè§ˆå™¨
   ```bash
   docker compose up -d browser
   ```
   - å°†å¯åŠ¨ä¸€ä¸ªåä¸º lm_cf_browser çš„å®¹å™¨å¹¶æ˜ å°„ 4444(WebDriver)/7900(noVNC)
   - æ¸…å•å·²åŒ…å« `extra_hosts: host.docker.internal:host-gateway` ä»¥ä¾¿å®¹å™¨è®¿é—®å®¿ä¸» 5102/5103
3) è¿è¡Œå¼•å¯¼å™¨è¿æ¥è¿œç«¯ WebDriverã€æ³¨å…¥ Userscript å¹¶å¯¼èˆª
   ```bash
   # æ¨èå¸¦è‡ªæ£€ï¼Œç¡®è®¤â€œå®¹å™¨æµè§ˆå™¨ â‡„ Userscript â‡„ æœ¬åœ°åç«¯â€é“¾è·¯ç•…é€š
   python scripts\docker_browser_runner.py --url https://lmarena.ai/ --self-test --keep-container
   ```
   è¯´æ˜ï¼š
   - å¼•å¯¼å™¨ä¼šæ£€æµ‹åˆ°åä¸º `lm_cf_browser` çš„å®¹å™¨å·²åœ¨è¿è¡Œï¼Œæ•…ä¸ä¼šé‡å¤åˆ›å»º
   - è‹¥é‡ Cloudflareï¼Œäººæœºä¼šåœ¨ç»ˆç«¯æç¤ºæ‰“å¼€ noVNCï¼š  
     http://localhost:7900/?autoconnect=1&amp;resize=scale&amp;password=secret
   - å®Œæˆäººå·¥éªŒè¯åå›è½¦ç»§ç»­ï¼›æ ‡é¢˜å‡ºç°â€œâœ…â€ä»£è¡¨ Userscript å·²è¿ä¸Šæœ¬åœ° WebSocket

å¸¸ç”¨æ“ä½œ
- æŸ¥çœ‹æ—¥å¿—ï¼ˆå®¹å™¨ä¾§ï¼‰
  ```bash
  docker compose logs -f browser
  ```
- åœæ­¢/é”€æ¯
  ```bash
  docker compose stop browser
  docker compose down
  ```

å¯é€‰ï¼šæŒä¹…åŒ–æµè§ˆå™¨é…ç½®ï¼ˆä¿ç•™ç™»å½•/Cookieï¼‰
- éœ€è¦åœ¨ [`docker-compose.yml`](docker-compose.yml:1) çš„ `services.browser` ä¸‹è‡ªè¡Œæ·»åŠ ï¼ˆç¤ºä¾‹ï¼ŒæŒ‰éœ€å¼€å¯ï¼‰ï¼š
  ```yaml
  volumes:
    - chrome-config:/home/seluser/.config/google-chrome
    - chrome-cache:/home/seluser/.cache
  ```
  å¹¶åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š
  ```yaml
  volumes:
    chrome-config:
    chrome-cache:
  ```
- è¿™æ ·é‡å¯å®¹å™¨åä»èƒ½ä¿ç•™ä¼šè¯ä¸ç¼“å­˜ï¼ˆæ³¨æ„éšç§ä¸ç©ºé—´å ç”¨ï¼‰ã€‚
